{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/home/user/iPC_Data_Portal/node_modules/@babel/runtime/regenerator\");\n\nfunction _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _lodash = require(\"lodash\");\n\nvar _recompose = require(\"recompose\");\n\nvar _emotion = require(\"emotion\");\n\nvar _Input = _interopRequireDefault(require(\"../Input\"));\n\nvar _Tabs = _interopRequireWildcard(require(\"../Tabs\"));\n\nvar _MatchBox = require(\"../MatchBox\");\n\nvar _QuickSearchQuery = _interopRequireDefault(require(\"./QuickSearch/QuickSearchQuery\"));\n\nvar _saveSet3 = _interopRequireDefault(require(\"../utils/saveSet\"));\n\nvar _formatNumber = _interopRequireDefault(require(\"../utils/formatNumber\"));\n\nvar _parseInputFiles = _interopRequireDefault(require(\"../utils/parseInputFiles\"));\n\nvar _utils = require(\"../SQONView/utils\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _getRequireWildcardCache() {\n  if (typeof WeakMap !== \"function\") return null;\n  var cache = new WeakMap();\n\n  _getRequireWildcardCache = function _getRequireWildcardCache() {\n    return cache;\n  };\n\n  return cache;\n}\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || _typeof(obj) !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache();\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj.default = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n}\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction _objectWithoutProperties(source, excluded) {\n  if (source == null) return {};\n\n  var target = _objectWithoutPropertiesLoose(source, excluded);\n\n  var key, i;\n\n  if (Object.getOwnPropertySymbols) {\n    var sourceSymbolKeys = Object.getOwnPropertySymbols(source);\n\n    for (i = 0; i < sourceSymbolKeys.length; i++) {\n      key = sourceSymbolKeys[i];\n      if (excluded.indexOf(key) >= 0) continue;\n      if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;\n      target[key] = source[key];\n    }\n  }\n\n  return target;\n}\n\nfunction _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nvar layoutStyle =\n/*#__PURE__*/\n(0, _emotion.css)(\"&.match-box{display:flex;flex-direction:column;.match-box-results-table{display:flex;flex-direction:column;}.tabs{display:flex;flex-direction:column;}.tabs .tabs-content{display:flex;flex-direction:column;}.tabs .tabs-titles{display:block;}.tabs .tabs-titles .tabs-title{float:left;}}\");\nvar enhance = (0, _recompose.compose)((0, _recompose.withState)('activeEntityField', 'setActiveEntityField', null), (0, _recompose.withState)('searchTextLoading', 'setSearchTextLoading', false), (0, _recompose.withState)('searchText', 'setSearchText', ''), (0, _recompose.withHandlers)({\n  onEntityChange: function onEntityChange(_ref) {\n    var setActiveEntityField = _ref.setActiveEntityField;\n    return function (_ref2) {\n      var value = _ref2.target.value;\n      return setActiveEntityField(value);\n    };\n  },\n  onTextChange: function onTextChange(_ref3) {\n    var setSearchText = _ref3.setSearchText;\n    return function (_ref4) {\n      var value = _ref4.target.value;\n      return setSearchText(value);\n    };\n  },\n  onFileUpload: function onFileUpload(_ref5) {\n    var setSearchText = _ref5.setSearchText,\n        setSearchTextLoading = _ref5.setSearchTextLoading;\n    return (\n      /*#__PURE__*/\n      function () {\n        var _ref6 = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee(_ref7) {\n          var files, contents;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  files = _ref7.target.files;\n                  setSearchTextLoading(true);\n                  _context.next = 4;\n                  return (0, _parseInputFiles.default)({\n                    files: files\n                  });\n\n                case 4:\n                  contents = _context.sent;\n                  setSearchText((contents || []).map(function (f) {\n                    return f.content;\n                  }).reduce(function (str, c) {\n                    return \"\".concat(str).concat(c, \"\\n\");\n                  }, \"\"));\n                  setSearchTextLoading(false);\n\n                case 7:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }));\n\n        return function (_x) {\n          return _ref6.apply(this, arguments);\n        };\n      }()\n    );\n  }\n}));\n\nvar EntitySelectionSection = function EntitySelectionSection(_ref8) {\n  var entitySelectText = _ref8.entitySelectText,\n      onEntityChange = _ref8.onEntityChange,\n      entitySelectPlaceholder = _ref8.entitySelectPlaceholder,\n      activeFields = _ref8.activeFields,\n      uploadableFields = _ref8.uploadableFields;\n  return _react.default.createElement(\"div\", {\n    className: \"match-box-select-entity-form\"\n  }, _react.default.createElement(\"div\", {\n    className: \"match-box-entity-select-text\"\n  }, entitySelectText), _react.default.createElement(\"select\", {\n    onChange: onEntityChange\n  }, _react.default.createElement(\"option\", {\n    value: null\n  }, entitySelectPlaceholder), activeFields.filter(function (_ref9) {\n    var field = _ref9.keyField.field;\n    return uploadableFields ? uploadableFields.includes(field) : true;\n  }).map(function (_ref10) {\n    var field = _ref10.field,\n        displayName = _ref10.displayName;\n    return _react.default.createElement(\"option\", {\n      key: field,\n      value: field\n    }, (0, _lodash.capitalize)(displayName));\n  })));\n};\n\nvar inputRef = _react.default.createRef();\n\nvar MatchBox = function MatchBox(_ref11) {\n  var sqon = _ref11.sqon,\n      setSQON = _ref11.setSQON,\n      matchHeaderText = _ref11.matchHeaderText,\n      _ref11$instructionTex = _ref11.instructionText,\n      instructionText = _ref11$instructionTex === void 0 ? \"Type or copy-and-paste a list of comma delimited identifiers\" : _ref11$instructionTex,\n      _ref11$placeholderTex = _ref11.placeholderText,\n      placeholderText = _ref11$placeholderTex === void 0 ? \"e.g. Id\\ne.g. Id\" : _ref11$placeholderTex,\n      _ref11$entitySelectTe = _ref11.entitySelectText,\n      entitySelectText = _ref11$entitySelectTe === void 0 ? \"Select the entity to upload\" : _ref11$entitySelectTe,\n      _ref11$entitySelectPl = _ref11.entitySelectPlaceholder,\n      entitySelectPlaceholder = _ref11$entitySelectPl === void 0 ? \"Select an Entity\" : _ref11$entitySelectPl,\n      _ref11$matchedTabTitl = _ref11.matchedTabTitle,\n      matchedTabTitle = _ref11$matchedTabTitl === void 0 ? \"Matched\" : _ref11$matchedTabTitl,\n      _ref11$unmatchedTabTi = _ref11.unmatchedTabTitle,\n      unmatchedTabTitle = _ref11$unmatchedTabTi === void 0 ? \"Unmatched\" : _ref11$unmatchedTabTi,\n      _ref11$matchTableColu = _ref11.matchTableColumnHeaders,\n      matchTableColumnHeaders = _ref11$matchTableColu === void 0 ? {\n    inputId: \"Input Id\",\n    matchedEntity: \"Matched Entity\",\n    entityId: \"Entity Id\"\n  } : _ref11$matchTableColu,\n      _ref11$browseButtonTe = _ref11.browseButtonText,\n      browseButtonText = _ref11$browseButtonTe === void 0 ? \"Browse\" : _ref11$browseButtonTe,\n      _ref11$ButtonComponen = _ref11.ButtonComponent,\n      ButtonComponent = _ref11$ButtonComponen === void 0 ? 'button' : _ref11$ButtonComponen,\n      _ref11$LoadingCompone = _ref11.LoadingComponent,\n      LoadingComponent = _ref11$LoadingCompone === void 0 ? _react.default.createElement(\"div\", null, \"...\") : _ref11$LoadingCompone,\n      children = _ref11.children,\n      searchText = _ref11.searchText,\n      searchTextParts = _ref11.searchTextParts,\n      searchTextLoading = _ref11.searchTextLoading,\n      _ref11$uploadInstruct = _ref11.uploadInstructionText,\n      uploadInstructionText = _ref11$uploadInstruct === void 0 ? 'Or choose file to upload' : _ref11$uploadInstruct,\n      onTextChange = _ref11.onTextChange,\n      onFileUpload = _ref11.onFileUpload,\n      onEntityChange = _ref11.onEntityChange,\n      activeEntityField = _ref11.activeEntityField,\n      _ref11$uploadableFiel = _ref11.uploadableFields,\n      uploadableFields = _ref11$uploadableFiel === void 0 ? null : _ref11$uploadableFiel,\n      setActiveEntityField = _ref11.setActiveEntityField,\n      props = _objectWithoutProperties(_ref11, [\"sqon\", \"setSQON\", \"matchHeaderText\", \"instructionText\", \"placeholderText\", \"entitySelectText\", \"entitySelectPlaceholder\", \"matchedTabTitle\", \"unmatchedTabTitle\", \"matchTableColumnHeaders\", \"browseButtonText\", \"ButtonComponent\", \"LoadingComponent\", \"children\", \"searchText\", \"searchTextParts\", \"searchTextLoading\", \"uploadInstructionText\", \"onTextChange\", \"onFileUpload\", \"onEntityChange\", \"activeEntityField\", \"uploadableFields\", \"setActiveEntityField\"]);\n\n  var selectableEntityType = !(uploadableFields && (uploadableFields || []).length === 1);\n  return _react.default.createElement(\"div\", {\n    className: \"match-box \".concat(layoutStyle)\n  }, _react.default.createElement(_MatchBox.MatchBoxState, _extends({}, props, {\n    onInitialLoaded: function onInitialLoaded(_ref12) {\n      var activeFields = _ref12.activeFields;\n\n      if (!selectableEntityType) {\n        var activeFieldToSet = activeFields.find(function (_ref13) {\n          var field = _ref13.keyField.field;\n          return uploadableFields[0] === field;\n        });\n\n        if (activeFieldToSet) {\n          setActiveEntityField(activeFieldToSet.field);\n        } else {\n          throw new Error(\"no no active field found by the path \".concat(uploadableFields[0]));\n        }\n      }\n    },\n    render: function render(_ref14) {\n      var primaryKeyField = _ref14.primaryKeyField,\n          activeFields = _ref14.activeFields,\n          _ref14$activeField = _ref14.activeField,\n          activeField = _ref14$activeField === void 0 ? activeFields.find(function (x) {\n        return x.field === activeEntityField;\n      }) : _ref14$activeField;\n      return _react.default.createElement(_react.Fragment, null, !selectableEntityType ? null : _react.default.createElement(EntitySelectionSection, {\n        entitySelectText: entitySelectText,\n        onEntityChange: onEntityChange,\n        entitySelectPlaceholder: entitySelectPlaceholder,\n        activeFields: activeFields,\n        uploadableFields: uploadableFields\n      }), _react.default.createElement(\"div\", {\n        className: \"match-box-id-form\"\n      }, _react.default.createElement(\"div\", {\n        className: \"match-box-selection-text\"\n      }, instructionText), _react.default.createElement(_Input.default, {\n        disabled: !activeField,\n        Component: \"textarea\",\n        placeholder: placeholderText,\n        value: searchText,\n        onChange: onTextChange,\n        \"aria-label\": \"Match box\"\n      }), _react.default.createElement(\"div\", {\n        className: \"match-box-upload-instruction-text\"\n      }, uploadInstructionText), _react.default.createElement(\"div\", {\n        className:\n        /*#__PURE__*/\n\n        /*#__PURE__*/\n        (0, _emotion.css)(\"display:flex;\")\n      }, _react.default.createElement(\"input\", {\n        type: \"file\",\n        className:\n        /*#__PURE__*/\n\n        /*#__PURE__*/\n        (0, _emotion.css)(\"position:absolute;top:-10000px;left:0px;\"),\n        \"aria-label\": \"File upload\",\n        accept: \".tsv,.csv,text/*\",\n        ref: inputRef,\n        multiple: true,\n        onChange: onFileUpload\n      }), _react.default.createElement(ButtonComponent, {\n        disabled: !activeField,\n        type: \"submit\",\n        onClick: function onClick() {\n          return inputRef.current.click();\n        }\n      }, searchTextLoading ? LoadingComponent : browseButtonText))), _react.default.createElement(_QuickSearchQuery.default, _extends({\n        exact: true,\n        size: 9999999 // TODO: pagination - this will currently choke on large input\n\n      }, props, {\n        searchText: searchText,\n        primaryKeyField: activeField === null || activeField === void 0 ? void 0 : activeField.keyField,\n        quickSearchFields: activeField === null || activeField === void 0 ? void 0 : activeField.searchFields,\n        mapResults: function mapResults(_ref15) {\n          var results = _ref15.results,\n              searchTextParts = _ref15.searchTextParts;\n          return {\n            results: (0, _lodash.uniqBy)(results, 'primaryKey'),\n            unmatchedKeys: (0, _lodash.difference)(searchTextParts, results.map(function (x) {\n              return x.input;\n            }))\n          };\n        },\n        render: function render(_ref16) {\n          var results = _ref16.results,\n              unmatchedKeys = _ref16.unmatchedKeys,\n              quickSearchSqon = _ref16.sqon;\n          return _react.default.createElement(\"div\", {\n            className: \"match-box-results-table\"\n          }, !!searchText.length && _react.default.createElement(_react.Fragment, null, matchHeaderText, _react.default.createElement(_Tabs.default, {\n            tabs: [{\n              key: 'matched',\n              title: \"\".concat(matchedTabTitle, \" (\").concat((0, _formatNumber.default)(results.length), \")\"),\n              content: _react.default.createElement(_Tabs.TabsTable, {\n                columns: ['inputId', 'matchedEntity', 'entityId'].map(function (x) {\n                  return {\n                    Header: matchTableColumnHeaders[x],\n                    accessor: x\n                  };\n                }),\n                data: results.length ? results.map(function (_ref17) {\n                  var input = _ref17.input,\n                      entityName = _ref17.entityName,\n                      primaryKey = _ref17.primaryKey;\n                  return {\n                    inputId: input,\n                    matchedEntity: entityName,\n                    entityId: primaryKey\n                  };\n                }) : [{\n                  inputId: '',\n                  matchedEntity: '',\n                  entityId: ''\n                }]\n              })\n            }, {\n              key: 'unmatched',\n              title: \"\".concat(unmatchedTabTitle, \" (\").concat((0, _formatNumber.default)(unmatchedKeys.length), \")\"),\n              content: _react.default.createElement(_Tabs.TabsTable, {\n                columns: [{\n                  Header: matchTableColumnHeaders.inputId,\n                  accessor: 'inputId'\n                }],\n                data: (unmatchedKeys === null || unmatchedKeys === void 0 ? void 0 : unmatchedKeys.length) ? unmatchedKeys.map(function (x) {\n                  return {\n                    inputId: x\n                  };\n                }) : [{\n                  inputId: ''\n                }]\n              })\n            }]\n          })), children({\n            hasResults: results === null || results === void 0 ? void 0 : results.length,\n            saveSet: function () {\n              var _saveSet2 = _asyncToGenerator(\n              /*#__PURE__*/\n              _regeneratorRuntime.mark(function _callee2(_ref18) {\n                var userId, api, _ref18$dataPath, dataPath, data, nextSQON;\n\n                return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                  while (1) {\n                    switch (_context2.prev = _context2.next) {\n                      case 0:\n                        userId = _ref18.userId, api = _ref18.api, _ref18$dataPath = _ref18.dataPath, dataPath = _ref18$dataPath === void 0 ? 'data.data.saveSet' : _ref18$dataPath;\n                        _context2.t0 = _lodash.get;\n                        _context2.next = 4;\n                        return (0, _saveSet3.default)({\n                          sqon: quickSearchSqon,\n                          type: props.graphqlField,\n                          userId: userId,\n                          path: primaryKeyField.field,\n                          api: api\n                        });\n\n                      case 4:\n                        _context2.t1 = _context2.sent;\n                        _context2.t2 = dataPath;\n                        data = (0, _context2.t0)(_context2.t1, _context2.t2);\n                        nextSQON = (0, _utils.toggleSQON)({\n                          op: 'and',\n                          content: [{\n                            op: 'in',\n                            content: {\n                              field: primaryKeyField === null || primaryKeyField === void 0 ? void 0 : primaryKeyField.field,\n                              value: [\"set_id:\".concat(data.setId)]\n                            }\n                          }]\n                        }, sqon);\n                        setSQON === null || setSQON === void 0 ? void 0 : setSQON(nextSQON);\n                        return _context2.abrupt(\"return\", _objectSpread({}, data, {\n                          nextSQON: nextSQON\n                        }));\n\n                      case 10:\n                      case \"end\":\n                        return _context2.stop();\n                    }\n                  }\n                }, _callee2);\n              }));\n\n              function saveSet(_x2) {\n                return _saveSet2.apply(this, arguments);\n              }\n\n              return saveSet;\n            }()\n          }));\n        }\n      })));\n    }\n  })));\n};\n\nvar _default = enhance(MatchBox);\n\nexports.default = _default;","map":null,"metadata":{},"sourceType":"script"}