{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"resolveSyntheticSqon\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.resolveSyntheticSqon;\n  }\n});\nObject.defineProperty(exports, \"removeSqonAtIndex\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.removeSqonAtIndex;\n  }\n});\nObject.defineProperty(exports, \"duplicateSqonAtIndex\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.duplicateSqonAtIndex;\n  }\n});\nObject.defineProperty(exports, \"isReference\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.isReference;\n  }\n});\nObject.defineProperty(exports, \"isValueObj\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.isValueObj;\n  }\n});\nObject.defineProperty(exports, \"isBooleanOp\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.isBooleanOp;\n  }\n});\nObject.defineProperty(exports, \"isFieldOp\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.isFieldOp;\n  }\n});\nObject.defineProperty(exports, \"isIndexReferencedInSqon\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.isIndexReferencedInSqon;\n  }\n});\nObject.defineProperty(exports, \"getDependentIndices\", {\n  enumerable: true,\n  get: function get() {\n    return _utils.getDependentIndices;\n  }\n});\nObject.defineProperty(exports, \"FieldOpModifier\", {\n  enumerable: true,\n  get: function get() {\n    return _index.default;\n  }\n});\nexports.default = void 0;\n\nvar _react = _interopRequireDefault(require(\"react\"));\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _lodash = require(\"lodash\");\n\nvar _reactComponentComponent = _interopRequireDefault(require(\"react-component-component\"));\n\nvar _config = require(\"../utils/config\");\n\nvar _SqonEntry = _interopRequireDefault(require(\"./SqonEntry\"));\n\nvar _utils = require(\"./utils\");\n\nrequire(\"./style.css\");\n\nvar _api = _interopRequireDefault(require(\"../utils/api\"));\n\nvar _clone = _interopRequireDefault(require(\"react-icons/lib/fa/clone\"));\n\nvar _plusCircle = _interopRequireDefault(require(\"react-icons/lib/fa/plus-circle\"));\n\nvar _index = _interopRequireDefault(require(\"./filterComponents/index\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _toConsumableArray(arr) {\n  return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread();\n}\n\nfunction _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance\");\n}\n\nfunction _iterableToArray(iter) {\n  if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter);\n}\n\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  }\n}\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nfunction _objectWithoutProperties(source, excluded) {\n  if (source == null) return {};\n\n  var target = _objectWithoutPropertiesLoose(source, excluded);\n\n  var key, i;\n\n  if (Object.getOwnPropertySymbols) {\n    var sourceSymbolKeys = Object.getOwnPropertySymbols(source);\n\n    for (i = 0; i < sourceSymbolKeys.length; i++) {\n      key = sourceSymbolKeys[i];\n      if (excluded.indexOf(key) >= 0) continue;\n      if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;\n      target[key] = source[key];\n    }\n  }\n\n  return target;\n}\n\nfunction _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nvar newEmptySqon = function newEmptySqon() {\n  return {\n    op: _utils.AND_OP,\n    content: []\n  };\n};\n\nvar defaultSqonDeletionHandler = function defaultSqonDeletionHandler(_ref) {\n  var indexToRemove = _ref.indexToRemove,\n      dependentIndices = _ref.dependentIndices,\n      s = _ref.internalStateContainer;\n  return new Promise(function (resolve, reject) {\n    s.setState({\n      deletingIndex: indexToRemove,\n      onSqonDeleteConfirmed: function onSqonDeleteConfirmed() {\n        var _s$setState;\n\n        s.setState((_s$setState = {\n          deletingIndex: null\n        }, _defineProperty(_s$setState, \"deletingIndex\", null), _defineProperty(_s$setState, \"onSqonDeleteConfirmed\", null), _s$setState));\n        resolve();\n      },\n      onSqonDeleteCancel: function onSqonDeleteCancel() {\n        var _s$setState2;\n\n        s.setState((_s$setState2 = {\n          deletingIndex: null\n        }, _defineProperty(_s$setState2, \"deletingIndex\", null), _defineProperty(_s$setState2, \"onSqonDeleteConfirmed\", null), _s$setState2));\n        reject();\n      }\n    });\n  });\n};\n\nvar AdvancedSqonBuilder = function AdvancedSqonBuilder(props) {\n  var _props$arrangerProjec = props.arrangerProjectId,\n      arrangerProjectId = _props$arrangerProjec === void 0 ? _config.PROJECT_ID : _props$arrangerProjec,\n      arrangerProjectIndex = props.arrangerProjectIndex,\n      _props$syntheticSqons = props.syntheticSqons,\n      syntheticSqons = _props$syntheticSqons === void 0 ? [] : _props$syntheticSqons,\n      _props$activeSqonInde = props.activeSqonIndex,\n      currentActiveSqonIndex = _props$activeSqonInde === void 0 ? 0 : _props$activeSqonInde,\n      _props$FieldOpModifie = props.FieldOpModifierContainer,\n      FieldOpModifierContainer = _props$FieldOpModifie === void 0 ? undefined : _props$FieldOpModifie,\n      _props$SqonActionComp = props.SqonActionComponent,\n      SqonActionComponent = _props$SqonActionComp === void 0 ? function (_ref2) {\n    var sqonIndex = _ref2.sqonIndex,\n        isActive = _ref2.isActive,\n        isSelected = _ref2.isSelected,\n        isHoverring = _ref2.isHoverring;\n    return null;\n  } : _props$SqonActionComp,\n      _props$onChange = props.onChange,\n      onChange = _props$onChange === void 0 ? function (_ref3) {\n    var newSyntheticSqons = _ref3.newSyntheticSqons;\n  } : _props$onChange,\n      _props$onActiveSqonSe = props.onActiveSqonSelect,\n      onActiveSqonSelect = _props$onActiveSqonSe === void 0 ? function (_ref4) {\n    var index = _ref4.index;\n  } : _props$onActiveSqonSe,\n      _props$fieldDisplayNa = props.fieldDisplayNameMap,\n      fieldDisplayNameMap = _props$fieldDisplayNa === void 0 ? {} : _props$fieldDisplayNa,\n      _props$ButtonComponen = props.ButtonComponent,\n      ButtonComponent = _props$ButtonComponen === void 0 ? function (_ref5) {\n    var className = _ref5.className,\n        rest = _objectWithoutProperties(_ref5, [\"className\"]);\n\n    return _react.default.createElement(\"button\", _extends({\n      className: \"button \".concat(className)\n    }, rest));\n  } : _props$ButtonComponen,\n      _props$getSqonDeleteC = props.getSqonDeleteConfirmation,\n      getSqonDeleteConfirmation = _props$getSqonDeleteC === void 0 ? defaultSqonDeletionHandler : _props$getSqonDeleteC,\n      _props$api = props.api,\n      api = _props$api === void 0 ? _api.default : _props$api,\n      _props$referenceColor = props.referenceColors,\n      referenceColors = _props$referenceColor === void 0 ? ['#cbeefb', '#fce8d3', '#eed5e9', '#cbebf1', '#f9d3d4', '#d5d7e9', '#fad9ea', '#f3ebd0'] : _props$referenceColor,\n      _props$emptyEntryMess = props.emptyEntryMessage,\n      emptyEntryMessage = _props$emptyEntryMess === void 0 ? null : _props$emptyEntryMess;\n  /**\n   * \"initialState\" is used in 'react-component-component', which provides a\n   * layer of state container, named 's', which consists of:\n   * {state, setState}\n   */\n\n  var initialState = {\n    selectedSqonIndices: [],\n    // the followings are to support defaultSqonDeletionHandler\n    deletingIndex: null,\n    onSqonDeleteConfirmed: null,\n    onSqonDeleteCancel: null\n  };\n  var selectedSyntheticSqon = syntheticSqons[currentActiveSqonIndex];\n  var allowsNewSqon = !syntheticSqons.some(_utils.isEmptySqon);\n\n  var getColorForReference = function getColorForReference(referenceIndex) {\n    return referenceColors[referenceIndex % referenceColors.length];\n  };\n\n  var isSqonReferenced = function isSqonReferenced(sqonIndex) {\n    return (0, _utils.isIndexReferencedInSqon)(selectedSyntheticSqon)(sqonIndex);\n  };\n\n  var clearSqonDeletion = function clearSqonDeletion(s) {\n    s.setState({\n      deletingIndex: null,\n      onSqonDeleteConfirmed: null,\n      onSqonDeleteCancel: null\n    });\n  };\n\n  var dispatchSqonListChange = function dispatchSqonListChange(s) {\n    return function (_ref6) {\n      var eventKey = _ref6.eventKey,\n          newSqonList = _ref6.newSqonList,\n          eventDetails = _ref6.eventDetails;\n      clearSqonDeletion(s); // wraps in promise to delay to allow delaying to next frame\n\n      return Promise.resolve(onChange({\n        eventKey: eventKey,\n        eventDetails: eventDetails,\n        newSyntheticSqons: newSqonList\n      }));\n    };\n  };\n\n  var onSelectedSqonIndicesChange = function onSelectedSqonIndicesChange(s) {\n    return function (index) {\n      return function () {\n        if (!s.state.selectedSqonIndices.includes(index) && !(0, _utils.isEmptySqon)(syntheticSqons[index])) {\n          s.setState({\n            selectedSqonIndices: [].concat(_toConsumableArray(s.state.selectedSqonIndices), [index]).sort()\n          });\n        } else {\n          s.setState({\n            selectedSqonIndices: s.state.selectedSqonIndices.filter(function (i) {\n              return i !== index;\n            })\n          });\n        }\n      };\n    };\n  };\n\n  var removeSqon = function removeSqon(s) {\n    return function (indexToRemove) {\n      onActiveSqonSelect({\n        index: Math.max(Math.min(syntheticSqons.length - 2, indexToRemove), 0)\n      });\n      var sqonListWithIndexRemoved = (0, _utils.removeSqonAtIndex)(indexToRemove, syntheticSqons);\n      return dispatchSqonListChange(s)({\n        eventKey: 'SQON_REMOVED',\n        eventDetails: {\n          removedIndex: indexToRemove\n        },\n        newSqonList: sqonListWithIndexRemoved.length ? sqonListWithIndexRemoved : [newEmptySqon()]\n      });\n    };\n  };\n\n  var onSqonRemove = function onSqonRemove(s) {\n    return function (indexToRemove) {\n      return function () {\n        return getSqonDeleteConfirmation({\n          internalStateContainer: s,\n          indexToRemove: indexToRemove,\n          dependentIndices: (0, _utils.getDependentIndices)(syntheticSqons)(indexToRemove)\n        }).then(function () {\n          return removeSqon(s)(indexToRemove);\n        }).catch(function () {});\n      };\n    };\n  };\n\n  var onSqonDuplicate = function onSqonDuplicate(s) {\n    return function (indexToDuplicate) {\n      return function () {\n        dispatchSqonListChange(s)({\n          eventKey: 'SQON_DUPLICATED',\n          eventDetails: {\n            duplicatedIndex: indexToDuplicate\n          },\n          newSqonList: [].concat(_toConsumableArray(syntheticSqons), [(0, _lodash.cloneDeep)(syntheticSqons[indexToDuplicate])])\n        }).then(function () {\n          return onActiveSqonSelect({\n            index: syntheticSqons.length\n          });\n        });\n      };\n    };\n  };\n\n  var createUnionSqon = function createUnionSqon(s) {\n    return function () {\n      dispatchSqonListChange(s)({\n        eventKey: 'NEW_UNION_COMBINATION',\n        eventDetails: {\n          referencedIndices: s.state.selectedSqonIndices\n        },\n        newSqonList: [].concat(_toConsumableArray(syntheticSqons), [{\n          op: _utils.OR_OP,\n          content: s.state.selectedSqonIndices\n        }])\n      }).then(function () {\n        return onActiveSqonSelect({\n          index: syntheticSqons.length\n        });\n      }).then(function () {\n        s.setState({\n          selectedSqonIndices: []\n        });\n        clearSqonDeletion(s);\n      });\n    };\n  };\n\n  var createIntersectSqon = function createIntersectSqon(s) {\n    return function () {\n      dispatchSqonListChange(s)({\n        eventKey: 'NEW_INTERSECTION_COMBINATION',\n        eventDetails: {\n          referencedIndices: s.state.selectedSqonIndices\n        },\n        newSqonList: [].concat(_toConsumableArray(syntheticSqons), [{\n          op: _utils.AND_OP,\n          content: s.state.selectedSqonIndices\n        }])\n      }).then(function () {\n        return onActiveSqonSelect({\n          index: syntheticSqons.length\n        });\n      }).then(function () {\n        s.setState({\n          selectedSqonIndices: []\n        });\n        clearSqonDeletion(s);\n      });\n    };\n  };\n\n  var onNewQueryClick = function onNewQueryClick(s) {\n    return function () {\n      if (allowsNewSqon) {\n        dispatchSqonListChange(s)({\n          eventKey: 'NEW_SQON',\n          eventDetails: {},\n          newSqonList: [].concat(_toConsumableArray(syntheticSqons), [newEmptySqon()])\n        }).then(function () {\n          return onActiveSqonSelect({\n            index: syntheticSqons.length\n          });\n        }).then(function () {\n          s.setState({\n            selectedSqonIndices: []\n          });\n          clearSqonDeletion(s);\n        });\n      }\n    };\n  };\n\n  var onClearAllClick = function onClearAllClick(s) {\n    return function () {\n      dispatchSqonListChange(s)({\n        eventKey: 'CLEAR_ALL',\n        eventDetails: {},\n        newSqonList: [newEmptySqon()]\n      });\n      s.setState({\n        selectedSqonIndices: []\n      });\n      clearSqonDeletion(s);\n      onActiveSqonSelect({\n        index: 0\n      });\n    };\n  };\n\n  var onSqonEntryActivate = function onSqonEntryActivate(s) {\n    return function (nextActiveSqonIndex) {\n      return function () {\n        if (nextActiveSqonIndex !== currentActiveSqonIndex) {\n          onActiveSqonSelect({\n            index: nextActiveSqonIndex\n          });\n        }\n      };\n    };\n  };\n\n  var onSqonChange = function onSqonChange(s) {\n    return function (sqonIndex) {\n      return function (newSqon) {\n        dispatchSqonListChange(s)({\n          eventKey: 'SQON_CHANGE',\n          eventDetails: {\n            updatedIndex: sqonIndex\n          },\n          newSqonList: syntheticSqons.map(function (sq, i) {\n            return i === sqonIndex ? newSqon : sq;\n          })\n        });\n\n        if (!newSqon.content.length) {\n          removeSqon(s)(sqonIndex);\n        }\n      };\n    };\n  };\n\n  var getActiveExecutableSqon = function getActiveExecutableSqon() {\n    return (0, _utils.resolveSyntheticSqon)(syntheticSqons)(selectedSyntheticSqon);\n  };\n\n  return _react.default.createElement(_utils.DisplayNameMapContext.Provider, {\n    value: fieldDisplayNameMap\n  }, _react.default.createElement(_reactComponentComponent.default, {\n    initialState: initialState\n  }, function (s) {\n    return _react.default.createElement(\"div\", {\n      className: \"sqonBuilder\"\n    }, _react.default.createElement(\"div\", {\n      className: \"actionHeaderContainer\"\n    }, _react.default.createElement(\"div\", null, _react.default.createElement(\"span\", null, \"Combine Queries: \"), _react.default.createElement(\"span\", null, _react.default.createElement(ButtonComponent, {\n      className: \"and\",\n      disabled: !s.state.selectedSqonIndices.length,\n      onClick: createIntersectSqon(s)\n    }, \"and\"), _react.default.createElement(ButtonComponent, {\n      className: \"or\",\n      disabled: !s.state.selectedSqonIndices.length,\n      onClick: createUnionSqon(s)\n    }, \"or\"))), _react.default.createElement(\"div\", null, _react.default.createElement(ButtonComponent, {\n      onClick: onClearAllClick(s)\n    }, \"CLEAR ALL\"))), syntheticSqons.map(function (sq, i) {\n      return _react.default.createElement(_SqonEntry.default, {\n        key: i,\n        index: i,\n        api: api,\n        arrangerProjectId: arrangerProjectId,\n        arrangerProjectIndex: arrangerProjectIndex,\n        syntheticSqon: sq,\n        isActiveSqon: i === currentActiveSqonIndex,\n        isSelected: s.state.selectedSqonIndices.includes(i),\n        isReferenced: isSqonReferenced(i),\n        isIndexReferenced: (0, _utils.isIndexReferencedInSqon)(selectedSyntheticSqon),\n        isDeleting: s.state.deletingIndex === i,\n        disabled: (0, _utils.isEmptySqon)(sq),\n        SqonActionComponent: SqonActionComponent,\n        FieldOpModifierContainer: FieldOpModifierContainer,\n        getActiveExecutableSqon: getActiveExecutableSqon,\n        getColorForReference: getColorForReference,\n        dependentIndices: (0, _utils.getDependentIndices)(syntheticSqons)(i),\n        onSqonChange: onSqonChange(s)(i),\n        onSqonCheckedChange: onSelectedSqonIndicesChange(s)(i),\n        onSqonDuplicate: onSqonDuplicate(s)(i),\n        onSqonRemove: onSqonRemove(s)(i),\n        onActivate: onSqonEntryActivate(s)(i),\n        onDeleteConfirmed: s.state.onSqonDeleteConfirmed || function () {},\n        onDeleteCanceled: s.state.onSqonDeleteCancel || function () {},\n        emptyEntryMessage: emptyEntryMessage\n      });\n    }), _react.default.createElement(\"div\", null, _react.default.createElement(\"button\", {\n      className: \"sqonListActionButton removeButton\",\n      disabled: !allowsNewSqon,\n      onClick: onNewQueryClick(s)\n    }, _react.default.createElement(_plusCircle.default, null), \" \", \"Start new query\"), _react.default.createElement(\"button\", {\n      className: \"sqonListActionButton duplicateButton\",\n      disabled: selectedSyntheticSqon ? !selectedSyntheticSqon.content.length : false,\n      onClick: onSqonDuplicate(s)(currentActiveSqonIndex)\n    }, _react.default.createElement(_clone.default, null), \" \", \"Duplicate Query\")));\n  }));\n};\n\nAdvancedSqonBuilder.propTypes = {\n  arrangerProjectId: _propTypes.default.string,\n  arrangerProjectIndex: _propTypes.default.string.isRequired,\n  syntheticSqons: _propTypes.default.arrayOf(_propTypes.default.object),\n  activeSqonIndex: _propTypes.default.number,\n  FieldOpModifierContainer: _propTypes.default.any,\n  SqonActionComponent: _propTypes.default.any,\n  onChange: _propTypes.default.func,\n  onActiveSqonSelect: _propTypes.default.func,\n  fieldDisplayNameMap: _propTypes.default.objectOf(_propTypes.default.string),\n  ButtonComponent: _propTypes.default.any,\n  getSqonDeleteConfirmation: _propTypes.default.func,\n  api: _propTypes.default.func,\n  referenceColors: _propTypes.default.arrayOf(_propTypes.default.string),\n  emptyEntryMessage: _propTypes.default.node\n};\nvar _default = AdvancedSqonBuilder;\nexports.default = _default;","map":null,"metadata":{},"sourceType":"script"}