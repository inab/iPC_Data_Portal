"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;
exports.opSwitch = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _constants = require("../constants");

var _normalizeFilters = _interopRequireDefault(require("./normalizeFilters"));

var _esFilter = require("../utils/esFilter");

var _wrappers;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === "[object Arguments]")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var wrapFilter = function wrapFilter(_ref) {
  var esFilter = _ref.esFilter,
      nestedFields = _ref.nestedFields,
      filter = _ref.filter,
      isNot = _ref.isNot;
  return filter.content.field.split('.').slice(0, -1).map(function (p, i, segments) {
    return segments.slice(0, i + 1).join('.');
  }).filter(function (p) {
    return nestedFields.includes(p);
  }).reverse().reduce(function (esFilter, path, i) {
    return (0, _esFilter.wrapNested)(esFilter, path);
  }, isNot ? (0, _esFilter.wrapMustNot)(esFilter) : esFilter);
};

function getRegexFilter(_ref2) {
  var nestedFields = _ref2.nestedFields,
      filter = _ref2.filter;

  var op = filter.op,
      _filter$content = filter.content,
      field = _filter$content.field,
      _filter$content$value = _slicedToArray(_filter$content.value, 1),
      value = _filter$content$value[0];

  var esFilter = wrapFilter({
    filter: filter,
    nestedFields: nestedFields,
    esFilter: {
      regexp: _defineProperty({}, field, value.replace('*', '.*'))
    },
    isNot: _constants.NOT_IN_OP === op
  });
  return op === _constants.SOME_NOT_IN_OP ? (0, _esFilter.wrapMustNot)(esFilter) : esFilter;
}

function getTermFilter(_ref3) {
  var _terms;

  var nestedFields = _ref3.nestedFields,
      filter = _ref3.filter;
  var op = filter.op,
      _filter$content2 = filter.content,
      value = _filter$content2.value,
      field = _filter$content2.field;
  var esFilter = wrapFilter({
    filter: filter,
    nestedFields: nestedFields,
    esFilter: {
      terms: (_terms = {}, _defineProperty(_terms, field, value.map(function (item) {
        return item || '';
      })), _defineProperty(_terms, "boost", 0), _terms)
    },
    isNot: _constants.NOT_IN_OP === op
  });
  return op === _constants.SOME_NOT_IN_OP ? (0, _esFilter.wrapMustNot)(esFilter) : esFilter;
}

function getFuzzyFilter(_ref4) {
  var nestedFields = _ref4.nestedFields,
      filter = _ref4.filter;
  var content = filter.content;
  var value = content.value,
      fields = content.fields; // group queries by their nesting level

  var sortedNested = nestedFields.slice().sort(function (a, b) {
    return b.length - a.length;
  });
  var nestedMap = fields.reduce(function (acc, field) {
    var group = sortedNested.find(function (y) {
      return field.includes(y);
    }) || '';

    if (acc[group]) {
      acc[group].push(field);
    } else {
      acc[group] = [field];
    }

    return acc;
  }, {}); // construct one multi match per nested group

  return (0, _esFilter.wrapShould)(Object.values(nestedMap).map(function (fields) {
    return wrapFilter({
      filter: _objectSpread({}, filter, {
        content: _objectSpread({}, content, {
          field: fields[0]
        })
      }),
      nestedFields: nestedFields,
      esFilter: (0, _esFilter.wrapShould)(fields.map(function (field) {
        return _defineProperty({}, _constants.ES_WILDCARD, _defineProperty({}, field, {
          value: "".concat(value)
        }));
      }))
    });
  }));
}

function getMissingFilter(_ref6) {
  var nestedFields = _ref6.nestedFields,
      filter = _ref6.filter;
  var field = filter.content.field;
  return wrapFilter({
    esFilter: {
      exists: {
        field: field,
        boost: 0
      }
    },
    nestedFields: nestedFields,
    filter: filter,
    isNot: true
  });
}

function getRangeFilter(_ref7) {
  var nestedFields = _ref7.nestedFields,
      filter = _ref7.filter;
  var op = filter.op,
      _filter$content3 = filter.content,
      field = _filter$content3.field,
      value = _filter$content3.value;
  return wrapFilter({
    filter: filter,
    nestedFields: nestedFields,
    esFilter: {
      range: _defineProperty({}, field, _defineProperty({
        boost: 0
      }, op, (0, _esFilter.toEsRangeValue)([_constants.GT_OP, _constants.GTE_OP].includes(op) ? _lodash["default"].max(value) : _lodash["default"].min(value))))
    }
  });
}

function collapseNestedFilters(_ref8) {
  var esFilter = _ref8.esFilter,
      bools = _ref8.bools;
  var filterIsNested = (0, _esFilter.isNested)(esFilter);
  var basePath = [].concat(_toConsumableArray(filterIsNested ? [_constants.ES_NESTED, _constants.ES_QUERY] : []), [_constants.ES_BOOL]);
  var path = [_constants.ES_MUST, _constants.ES_MUST_NOT].map(function (p) {
    return [].concat(_toConsumableArray(basePath), [p]);
  }).find(function (path) {
    return _lodash["default"].get(esFilter, path);
  });
  var found = path && bools.find(function (bool) {
    return filterIsNested ? (0, _esFilter.readPath)(bool) === (0, _esFilter.readPath)(esFilter) : _lodash["default"].get(bool, path);
  });
  return [].concat(_toConsumableArray(bools.filter(function (bool) {
    return bool !== found;
  })), [found ? (0, _esFilter.mergePath)(found, path, filterIsNested ? collapseNestedFilters({
    esFilter: _lodash["default"].get(esFilter, path)[0],
    bools: _lodash["default"].get(found, path, [])
  }) : [].concat(_toConsumableArray(_lodash["default"].get(found, path)), _toConsumableArray(_lodash["default"].get(esFilter, path)))) : esFilter]);
}

var wrappers = (_wrappers = {}, _defineProperty(_wrappers, _constants.AND_OP, _esFilter.wrapMust), _defineProperty(_wrappers, _constants.OR_OP, _esFilter.wrapShould), _defineProperty(_wrappers, _constants.NOT_OP, _esFilter.wrapMustNot), _wrappers);

function getGroupFilter(_ref9) {
  var _esFilters$, _esFilters$2;

  var nestedFields = _ref9.nestedFields,
      _ref9$filter = _ref9.filter,
      content = _ref9$filter.content,
      op = _ref9$filter.op,
      pivot = _ref9$filter.pivot;
  var applyBooleanWrapper = wrappers[op];
  var esFilters = content.map(function (filter) {
    return opSwitch({
      nestedFields: nestedFields,
      filter: filter
    });
  });
  var isNested = !!((_esFilters$ = esFilters[0]) === null || _esFilters$ === void 0 ? void 0 : _esFilters$.nested);

  if (isNested && pivot === ((_esFilters$2 = esFilters[0]) === null || _esFilters$2 === void 0 ? void 0 : _esFilters$2.nested.path)) {
    var flattned = esFilters.reduce(function (bools, esFilter) {
      return op === _constants.AND_OP || op === _constants.NOT_OP ? collapseNestedFilters({
        esFilter: esFilter,
        bools: bools
      }) : [].concat(_toConsumableArray(bools), [esFilter]);
    }, []);
    return applyBooleanWrapper(flattned);
  } else {
    return applyBooleanWrapper(esFilters);
  }
}

function getSetFilter(_ref10) {
  var nestedFields = _ref10.nestedFields,
      filter = _ref10.filter,
      _ref10$filter = _ref10.filter,
      content = _ref10$filter.content,
      op = _ref10$filter.op;
  return wrapFilter({
    isNot: op === _constants.NOT_IN_OP,
    filter: filter,
    nestedFields: nestedFields,
    esFilter: {
      terms: _defineProperty({
        boost: 0
      }, content.field, {
        index: _constants.ES_ARRANGER_SET_INDEX,
        type: _constants.ES_ARRANGER_SET_TYPE,
        id: _lodash["default"].flatMap([content.value])[0].replace('set_id:', ''),
        path: 'ids'
      })
    }
  });
}

var getBetweenFilter = function getBetweenFilter(_ref11) {
  var _field2;

  var nestedFields = _ref11.nestedFields,
      filter = _ref11.filter;
  var _filter$content4 = filter.content,
      field = _filter$content4.field,
      value = _filter$content4.value;
  return wrapFilter({
    filter: filter,
    nestedFields: nestedFields,
    esFilter: {
      range: _defineProperty({}, field, (_field2 = {
        boost: 0
      }, _defineProperty(_field2, _constants.GTE_OP, _lodash["default"].min(value)), _defineProperty(_field2, _constants.LTE_OP, _lodash["default"].max(value)), _field2))
    }
  });
};

var opSwitch = function opSwitch(_ref12) {
  var nestedFields = _ref12.nestedFields,
      filter = _ref12.filter;
  var op = filter.op,
      pivot = filter.pivot,
      value = filter.content.value; // we need a way to handle object fields before the following error is valid
  // if (pivot && pivot !== '.' && !nestedFields.includes(pivot)) {
  //   throw new Error(`Invalid pivot field "${pivot}", not a nested field`);
  // }

  if ([_constants.OR_OP, _constants.AND_OP, _constants.NOT_OP].includes(op)) {
    return getGroupFilter({
      nestedFields: nestedFields,
      filter: filter
    });
  } else if ([_constants.IN_OP, _constants.NOT_IN_OP, _constants.SOME_NOT_IN_OP].includes(op)) {
    if ("".concat(value[0]).includes(_constants.REGEX)) {
      return getRegexFilter({
        nestedFields: nestedFields,
        filter: filter
      });
    } else if ("".concat(value[0]).includes(_constants.SET_ID)) {
      return getSetFilter({
        nestedFields: nestedFields,
        filter: filter
      });
    } else if ("".concat(value[0]).includes(_constants.MISSING)) {
      return getMissingFilter({
        nestedFields: nestedFields,
        filter: filter
      });
    } else {
      return getTermFilter({
        nestedFields: nestedFields,
        filter: filter
      });
    }
  } else if ([_constants.ALL_OP].includes(op)) {
    return getGroupFilter({
      nestedFields: nestedFields,
      filter: {
        op: _constants.AND_OP,
        pivot: pivot || '.',
        content: filter.content.value.map(function (v) {
          return {
            op: _constants.IN_OP,
            content: {
              field: filter.content.field,
              value: [v]
            }
          };
        })
      }
    });
  } else if ([_constants.GT_OP, _constants.GTE_OP, _constants.LT_OP, _constants.LTE_OP].includes(op)) {
    return getRangeFilter({
      nestedFields: nestedFields,
      filter: filter
    });
  } else if ([_constants.BETWEEN_OP].includes(op)) {
    return getBetweenFilter({
      nestedFields: nestedFields,
      filter: filter
    });
  } else if (_constants.FILTER_OP === op) {
    return getFuzzyFilter({
      nestedFields: nestedFields,
      filter: filter
    });
  } else {
    throw new Error('unknown op');
  }
};

exports.opSwitch = opSwitch;

function _default(_ref13) {
  var nestedFields = _ref13.nestedFields,
      rawFilters = _ref13.filters;
  if (Object.keys(rawFilters || {}).length === 0) return {};
  return opSwitch({
    nestedFields: nestedFields,
    filter: (0, _normalizeFilters["default"])(rawFilters)
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZFF1ZXJ5L2luZGV4LmpzIl0sIm5hbWVzIjpbIndyYXBGaWx0ZXIiLCJlc0ZpbHRlciIsIm5lc3RlZEZpZWxkcyIsImZpbHRlciIsImlzTm90IiwiY29udGVudCIsImZpZWxkIiwic3BsaXQiLCJzbGljZSIsIm1hcCIsInAiLCJpIiwic2VnbWVudHMiLCJqb2luIiwiaW5jbHVkZXMiLCJyZXZlcnNlIiwicmVkdWNlIiwicGF0aCIsImdldFJlZ2V4RmlsdGVyIiwib3AiLCJ2YWx1ZSIsInJlZ2V4cCIsInJlcGxhY2UiLCJOT1RfSU5fT1AiLCJTT01FX05PVF9JTl9PUCIsImdldFRlcm1GaWx0ZXIiLCJ0ZXJtcyIsIml0ZW0iLCJnZXRGdXp6eUZpbHRlciIsImZpZWxkcyIsInNvcnRlZE5lc3RlZCIsInNvcnQiLCJhIiwiYiIsImxlbmd0aCIsIm5lc3RlZE1hcCIsImFjYyIsImdyb3VwIiwiZmluZCIsInkiLCJwdXNoIiwiT2JqZWN0IiwidmFsdWVzIiwiRVNfV0lMRENBUkQiLCJnZXRNaXNzaW5nRmlsdGVyIiwiZXhpc3RzIiwiYm9vc3QiLCJnZXRSYW5nZUZpbHRlciIsInJhbmdlIiwiR1RfT1AiLCJHVEVfT1AiLCJfIiwibWF4IiwibWluIiwiY29sbGFwc2VOZXN0ZWRGaWx0ZXJzIiwiYm9vbHMiLCJmaWx0ZXJJc05lc3RlZCIsImJhc2VQYXRoIiwiRVNfTkVTVEVEIiwiRVNfUVVFUlkiLCJFU19CT09MIiwiRVNfTVVTVCIsIkVTX01VU1RfTk9UIiwiZ2V0IiwiZm91bmQiLCJib29sIiwid3JhcHBlcnMiLCJBTkRfT1AiLCJ3cmFwTXVzdCIsIk9SX09QIiwid3JhcFNob3VsZCIsIk5PVF9PUCIsIndyYXBNdXN0Tm90IiwiZ2V0R3JvdXBGaWx0ZXIiLCJwaXZvdCIsImFwcGx5Qm9vbGVhbldyYXBwZXIiLCJlc0ZpbHRlcnMiLCJvcFN3aXRjaCIsImlzTmVzdGVkIiwibmVzdGVkIiwiZmxhdHRuZWQiLCJnZXRTZXRGaWx0ZXIiLCJpbmRleCIsIkVTX0FSUkFOR0VSX1NFVF9JTkRFWCIsInR5cGUiLCJFU19BUlJBTkdFUl9TRVRfVFlQRSIsImlkIiwiZmxhdE1hcCIsImdldEJldHdlZW5GaWx0ZXIiLCJMVEVfT1AiLCJJTl9PUCIsIlJFR0VYIiwiU0VUX0lEIiwiTUlTU0lORyIsIkFMTF9PUCIsInYiLCJMVF9PUCIsIkJFVFdFRU5fT1AiLCJGSUxURVJfT1AiLCJFcnJvciIsInJhd0ZpbHRlcnMiLCJmaWx0ZXJzIiwia2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUEyQkE7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFXQSxJQUFNQSxVQUFVLEdBQUcsU0FBYkEsVUFBYSxPQUErQztBQUFBLE1BQTVDQyxRQUE0QyxRQUE1Q0EsUUFBNEM7QUFBQSxNQUFsQ0MsWUFBa0MsUUFBbENBLFlBQWtDO0FBQUEsTUFBcEJDLE1BQW9CLFFBQXBCQSxNQUFvQjtBQUFBLE1BQVpDLEtBQVksUUFBWkEsS0FBWTtBQUNoRSxTQUFPRCxNQUFNLENBQUNFLE9BQVAsQ0FBZUMsS0FBZixDQUNKQyxLQURJLENBQ0UsR0FERixFQUVKQyxLQUZJLENBRUUsQ0FGRixFQUVLLENBQUMsQ0FGTixFQUdKQyxHQUhJLENBR0EsVUFBQ0MsQ0FBRCxFQUFJQyxDQUFKLEVBQU9DLFFBQVA7QUFBQSxXQUFvQkEsUUFBUSxDQUFDSixLQUFULENBQWUsQ0FBZixFQUFrQkcsQ0FBQyxHQUFHLENBQXRCLEVBQXlCRSxJQUF6QixDQUE4QixHQUE5QixDQUFwQjtBQUFBLEdBSEEsRUFJSlYsTUFKSSxDQUlHLFVBQUFPLENBQUM7QUFBQSxXQUFJUixZQUFZLENBQUNZLFFBQWIsQ0FBc0JKLENBQXRCLENBQUo7QUFBQSxHQUpKLEVBS0pLLE9BTEksR0FNSkMsTUFOSSxDQU9ILFVBQUNmLFFBQUQsRUFBV2dCLElBQVgsRUFBaUJOLENBQWpCO0FBQUEsV0FBdUIsMEJBQVdWLFFBQVgsRUFBcUJnQixJQUFyQixDQUF2QjtBQUFBLEdBUEcsRUFR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QUFNLENBQUM2RCxJQUFQLENBQVlGLFVBQVUsSUFBSSxFQUExQixFQUE4QmxFLE1BQTlCLEtBQXlDLENBQTdDLEVBQWdELE9BQU8sRUFBUDtBQUNoRCxTQUFPMkMsUUFBUSxDQUFDO0FBQ2QzRSxJQUFBQSxZQUFZLEVBQVpBLFlBRGM7QUFFZEMsSUFBQUEsTUFBTSxFQUFFLGtDQUFpQmlHLFVBQWpCO0FBRk0sR0FBRCxDQUFmO0FBSUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtcbiAgRVNfTkVTVEVELFxuICBFU19RVUVSWSxcbiAgRVNfQk9PTCxcbiAgQkVUV0VFTl9PUCxcbiAgR1RfT1AsXG4gIEdURV9PUCxcbiAgTFRfT1AsXG4gIExURV9PUCxcbiAgSU5fT1AsXG4gIE5PVF9JTl9PUCxcbiAgU09NRV9OT1RfSU5fT1AsXG4gIEVTX01VU1QsXG4gIEVTX01VU1RfTk9ULFxuICBFU19BUlJBTkdFUl9TRVRfSU5ERVgsXG4gIEVTX0FSUkFOR0VSX1NFVF9UWVBFLFxuICBPUl9PUCxcbiAgQU5EX09QLFxuICBGSUxURVJfT1AsXG4gIE5PVF9PUCxcbiAgUkVHRVgsXG4gIFNFVF9JRCxcbiAgTUlTU0lORyxcbiAgQUxMX09QLFxuICBFU19TSE9VTEQsXG4gIEVTX1dJTERDQVJELFxufSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IG5vcm1hbGl6ZUZpbHRlcnMgZnJvbSAnLi9ub3JtYWxpemVGaWx0ZXJzJztcbmltcG9ydCB7XG4gIGlzTmVzdGVkLFxuICByZWFkUGF0aCxcbiAgd3JhcE11c3ROb3QsXG4gIHdyYXBOZXN0ZWQsXG4gIG1lcmdlUGF0aCxcbiAgd3JhcFNob3VsZCxcbiAgd3JhcE11c3QsXG4gIHRvRXNSYW5nZVZhbHVlLFxufSBmcm9tICcuLi91dGlscy9lc0ZpbHRlcic7XG5cbmNvbnN0IHdyYXBGaWx0ZXIgPSAoeyBlc0ZpbHRlciwgbmVzdGVkRmllbGRzLCBmaWx0ZXIsIGlzTm90IH0pID0+IHtcbiAgcmV0dXJuIGZpbHRlci5jb250ZW50LmZpZWxkXG4gICAgLnNwbGl0KCcuJylcbiAgICAuc2xpY2UoMCwgLTEpXG4gICAgLm1hcCgocCwgaSwgc2VnbWVudHMpID0+IHNlZ21lbnRzLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcuJykpXG4gICAgLmZpbHRlcihwID0+IG5lc3RlZEZpZWxkcy5pbmNsdWRlcyhwKSlcbiAgICAucmV2ZXJzZSgpXG4gICAgLnJlZHVjZShcbiAgICAgIChlc0ZpbHRlciwgcGF0aCwgaSkgPT4gd3JhcE5lc3RlZChlc0ZpbHRlciwgcGF0aCksXG4gICAgICBpc05vdCA/IHdyYXBNdXN0Tm90KGVzRmlsdGVyKSA6IGVzRmlsdGVyLFxuICAgICk7XG59O1xuXG5mdW5jdGlvbiBnZXRSZWdleEZpbHRlcih7IG5lc3RlZEZpZWxkcywgZmlsdGVyIH0pIHtcbiAgY29uc3Qge1xuICAgIG9wLFxuICAgIGNvbnRlbnQ6IHtcbiAgICAgIGZpZWxkLFxuICAgICAgdmFsdWU6IFt2YWx1ZV0sXG4gICAgfSxcbiAgfSA9IGZpbHRlcjtcbiAgY29uc3QgZXNGaWx0ZXIgPSB3cmFwRmlsdGVyKHtcbiAgICBmaWx0ZXIsXG4gICAgbmVzdGVkRmllbGRzLFxuICAgIGVzRmlsdGVyOiB7IHJlZ2V4cDogeyBbZmllbGRdOiB2YWx1ZS5yZXBsYWNlKCcqJywgJy4qJykgfSB9LFxuICAgIGlzTm90OiBOT1RfSU5fT1AgPT09IG9wLFxuICB9KTtcblxuICByZXR1cm4gb3AgPT09IFNPTUVfTk9UX0lOX09QID8gd3JhcE11c3ROb3QoZXNGaWx0ZXIpIDogZXNGaWx0ZXI7XG59XG5cbmZ1bmN0aW9uIGdldFRlcm1GaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KSB7XG4gIGNvbnN0IHtcbiAgICBvcCxcbiAgICBjb250ZW50OiB7IHZhbHVlLCBmaWVsZCB9LFxuICB9ID0gZmlsdGVyO1xuICBjb25zdCBlc0ZpbHRlciA9IHdyYXBGaWx0ZXIoe1xuICAgIGZpbHRlcixcbiAgICBuZXN0ZWRGaWVsZHMsXG4gICAgZXNGaWx0ZXI6IHsgdGVybXM6IHsgW2ZpZWxkXTogdmFsdWUubWFwKGl0ZW0gPT4gaXRlbSB8fCAnJyksIGJvb3N0OiAwIH0gfSxcbiAgICBpc05vdDogTk9UX0lOX09QID09PSBvcCxcbiAgfSk7XG5cbiAgcmV0dXJuIG9wID09PSBTT01FX05PVF9JTl9PUCA/IHdyYXBNdXN0Tm90KGVzRmlsdGVyKSA6IGVzRmlsdGVyO1xufVxuXG5mdW5jdGlvbiBnZXRGdXp6eUZpbHRlcih7IG5lc3RlZEZpZWxkcywgZmlsdGVyIH0pIHtcbiAgY29uc3QgeyBjb250ZW50IH0gPSBmaWx0ZXI7XG4gIGNvbnN0IHsgdmFsdWUsIGZpZWxkcyB9ID0gY29udGVudDtcblxuICAvLyBncm91cCBxdWVyaWVzIGJ5IHRoZWlyIG5lc3RpbmcgbGV2ZWxcbiAgY29uc3Qgc29ydGVkTmVzdGVkID0gbmVzdGVkRmllbGRzLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gYi5sZW5ndGggLSBhLmxlbmd0aCk7XG4gIGNvbnN0IG5lc3RlZE1hcCA9IGZpZWxkcy5yZWR1Y2UoKGFjYywgZmllbGQpID0+IHtcbiAgICBjb25zdCBncm91cCA9IHNvcnRlZE5lc3RlZC5maW5kKHkgPT4gZmllbGQuaW5jbHVkZXMoeSkpIHx8ICcnO1xuICAgIGlmIChhY2NbZ3JvdXBdKSB7XG4gICAgICBhY2NbZ3JvdXBdLnB1c2goZmllbGQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhY2NbZ3JvdXBdID0gW2ZpZWxkXTtcbiAgICB9XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuXG4gIC8vIGNvbnN0cnVjdCBvbmUgbXVsdGkgbWF0Y2ggcGVyIG5lc3RlZCBncm91cFxuICByZXR1cm4gd3JhcFNob3VsZChcbiAgICBPYmplY3QudmFsdWVzKG5lc3RlZE1hcCkubWFwKGZpZWxkcyA9PlxuICAgICAgd3JhcEZpbHRlcih7XG4gICAgICAgIGZpbHRlcjogeyAuLi5maWx0ZXIsIGNvbnRlbnQ6IHsgLi4uY29udGVudCwgZmllbGQ6IGZpZWxkc1swXSB9IH0sXG4gICAgICAgIG5lc3RlZEZpZWxkcyxcbiAgICAgICAgZXNGaWx0ZXI6IHdyYXBTaG91bGQoXG4gICAgICAgICAgZmllbGRzLm1hcChmaWVsZCA9PiAoe1xuICAgICAgICAgICAgW0VTX1dJTERDQVJEXToge1xuICAgICAgICAgICAgICBbZmllbGRdOiB7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGAke3ZhbHVlfWAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICksXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldE1pc3NpbmdGaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KSB7XG4gIGNvbnN0IHtcbiAgICBjb250ZW50OiB7IGZpZWxkIH0sXG4gIH0gPSBmaWx0ZXI7XG4gIHJldHVybiB3cmFwRmlsdGVyKHtcbiAgICBlc0ZpbHRlcjogeyBleGlzdHM6IHsgZmllbGQ6IGZpZWxkLCBib29zdDogMCB9IH0sXG4gICAgbmVzdGVkRmllbGRzLFxuICAgIGZpbHRlcixcbiAgICBpc05vdDogdHJ1ZSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFJhbmdlRmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSkge1xuICBjb25zdCB7XG4gICAgb3AsXG4gICAgY29udGVudDogeyBmaWVsZCwgdmFsdWUgfSxcbiAgfSA9IGZpbHRlcjtcbiAgcmV0dXJuIHdyYXBGaWx0ZXIoe1xuICAgIGZpbHRlcixcbiAgICBuZXN0ZWRGaWVsZHMsXG4gICAgZXNGaWx0ZXI6IHtcbiAgICAgIHJhbmdlOiB7XG4gICAgICAgIFtmaWVsZF06IHtcbiAgICAgICAgICBib29zdDogMCxcbiAgICAgICAgICBbb3BdOiB0b0VzUmFuZ2VWYWx1ZShcbiAgICAgICAgICAgIFtHVF9PUCwgR1RFX09QXS5pbmNsdWRlcyhvcCkgPyBfLm1heCh2YWx1ZSkgOiBfLm1pbih2YWx1ZSksXG4gICAgICAgICAgKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNvbGxhcHNlTmVzdGVkRmlsdGVycyh7IGVzRmlsdGVyLCBib29scyB9KSB7XG4gIGNvbnN0IGZpbHRlcklzTmVzdGVkID0gaXNOZXN0ZWQoZXNGaWx0ZXIpO1xuICBjb25zdCBiYXNlUGF0aCA9IFsuLi4oZmlsdGVySXNOZXN0ZWQgPyBbRVNfTkVTVEVELCBFU19RVUVSWV0gOiBbXSksIEVTX0JPT0xdO1xuICBjb25zdCBwYXRoID0gW0VTX01VU1QsIEVTX01VU1RfTk9UXVxuICAgIC5tYXAocCA9PiBbLi4uYmFzZVBhdGgsIHBdKVxuICAgIC5maW5kKHBhdGggPT4gXy5nZXQoZXNGaWx0ZXIsIHBhdGgpKTtcblxuICBjb25zdCBmb3VuZCA9XG4gICAgcGF0aCAmJlxuICAgIGJvb2xzLmZpbmQoYm9vbCA9PlxuICAgICAgZmlsdGVySXNOZXN0ZWRcbiAgICAgICAgPyByZWFkUGF0aChib29sKSA9PT0gcmVhZFBhdGgoZXNGaWx0ZXIpXG4gICAgICAgIDogXy5nZXQoYm9vbCwgcGF0aCksXG4gICAgKTtcblxuICByZXR1cm4gW1xuICAgIC4uLmJvb2xzLmZpbHRlcihib29sID0+IGJvb2wgIT09IGZvdW5kKSxcbiAgICBmb3VuZFxuICAgICAgPyBtZXJnZVBhdGgoXG4gICAgICAgICAgZm91bmQsXG4gICAgICAgICAgcGF0aCxcbiAgICAgICAgICBmaWx0ZXJJc05lc3RlZFxuICAgICAgICAgICAgPyBjb2xsYXBzZU5lc3RlZEZpbHRlcnMoe1xuICAgICAgICAgICAgICAgIGVzRmlsdGVyOiBfLmdldChlc0ZpbHRlciwgcGF0aClbMF0sXG4gICAgICAgICAgICAgICAgYm9vbHM6IF8uZ2V0KGZvdW5kLCBwYXRoLCBbXSksXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICA6IFsuLi5fLmdldChmb3VuZCwgcGF0aCksIC4uLl8uZ2V0KGVzRmlsdGVyLCBwYXRoKV0sXG4gICAgICAgIClcbiAgICAgIDogZXNGaWx0ZXIsXG4gIF07XG59XG5cbmNvbnN0IHdyYXBwZXJzID0ge1xuICBbQU5EX09QXTogd3JhcE11c3QsXG4gIFtPUl9PUF06IHdyYXBTaG91bGQsXG4gIFtOT1RfT1BdOiB3cmFwTXVzdE5vdCxcbn07XG5mdW5jdGlvbiBnZXRHcm91cEZpbHRlcih7IG5lc3RlZEZpZWxkcywgZmlsdGVyOiB7IGNvbnRlbnQsIG9wLCBwaXZvdCB9IH0pIHtcbiAgY29uc3QgYXBwbHlCb29sZWFuV3JhcHBlciA9IHdyYXBwZXJzW29wXTtcbiAgY29uc3QgZXNGaWx0ZXJzID0gY29udGVudC5tYXAoZmlsdGVyID0+IG9wU3dpdGNoKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSkpO1xuICBjb25zdCBpc05lc3RlZCA9ICEhZXNGaWx0ZXJzWzBdPy5uZXN0ZWQ7XG4gIGlmIChpc05lc3RlZCAmJiBwaXZvdCA9PT0gZXNGaWx0ZXJzWzBdPy5uZXN0ZWQucGF0aCkge1xuICAgIGNvbnN0IGZsYXR0bmVkID0gZXNGaWx0ZXJzLnJlZHVjZShcbiAgICAgIChib29scywgZXNGaWx0ZXIpID0+XG4gICAgICAgIG9wID09PSBBTkRfT1AgfHwgb3AgPT09IE5PVF9PUFxuICAgICAgICAgID8gY29sbGFwc2VOZXN0ZWRGaWx0ZXJzKHsgZXNGaWx0ZXIsIGJvb2xzIH0pXG4gICAgICAgICAgOiBbLi4uYm9vbHMsIGVzRmlsdGVyXSxcbiAgICAgIFtdLFxuICAgICk7XG4gICAgcmV0dXJuIGFwcGx5Qm9vbGVhbldyYXBwZXIoZmxhdHRuZWQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhcHBseUJvb2xlYW5XcmFwcGVyKGVzRmlsdGVycyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2V0RmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIsIGZpbHRlcjogeyBjb250ZW50LCBvcCB9IH0pIHtcbiAgcmV0dXJuIHdyYXBGaWx0ZXIoe1xuICAgIGlzTm90OiBvcCA9PT0gTk9UX0lOX09QLFxuICAgIGZpbHRlcixcbiAgICBuZXN0ZWRGaWVsZHMsXG4gICAgZXNGaWx0ZXI6IHtcbiAgICAgIHRlcm1zOiB7XG4gICAgICAgIGJvb3N0OiAwLFxuICAgICAgICBbY29udGVudC5maWVsZF06IHtcbiAgICAgICAgICBpbmRleDogRVNfQVJSQU5HRVJfU0VUX0lOREVYLFxuICAgICAgICAgIHR5cGU6IEVTX0FSUkFOR0VSX1NFVF9UWVBFLFxuICAgICAgICAgIGlkOiBfLmZsYXRNYXAoW2NvbnRlbnQudmFsdWVdKVswXS5yZXBsYWNlKCdzZXRfaWQ6JywgJycpLFxuICAgICAgICAgIHBhdGg6ICdpZHMnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn1cblxuY29uc3QgZ2V0QmV0d2VlbkZpbHRlciA9ICh7IG5lc3RlZEZpZWxkcywgZmlsdGVyIH0pID0+IHtcbiAgY29uc3Qge1xuICAgIGNvbnRlbnQ6IHsgZmllbGQsIHZhbHVlIH0sXG4gIH0gPSBmaWx0ZXI7XG4gIHJldHVybiB3cmFwRmlsdGVyKHtcbiAgICBmaWx0ZXIsXG4gICAgbmVzdGVkRmllbGRzLFxuICAgIGVzRmlsdGVyOiB7XG4gICAgICByYW5nZToge1xuICAgICAgICBbZmllbGRdOiB7XG4gICAgICAgICAgYm9vc3Q6IDAsXG4gICAgICAgICAgW0dURV9PUF06IF8ubWluKHZhbHVlKSxcbiAgICAgICAgICBbTFRFX09QXTogXy5tYXgodmFsdWUpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBvcFN3aXRjaCA9ICh7IG5lc3RlZEZpZWxkcywgZmlsdGVyIH0pID0+IHtcbiAgY29uc3Qge1xuICAgIG9wLFxuICAgIHBpdm90LFxuICAgIGNvbnRlbnQ6IHsgdmFsdWUgfSxcbiAgfSA9IGZpbHRlcjtcbiAgLy8gd2UgbmVlZCBhIHdheSB0byBoYW5kbGUgb2JqZWN0IGZpZWxkcyBiZWZvcmUgdGhlIGZvbGxvd2luZyBlcnJvciBpcyB2YWxpZFxuICAvLyBpZiAocGl2b3QgJiYgcGl2b3QgIT09ICcuJyAmJiAhbmVzdGVkRmllbGRzLmluY2x1ZGVzKHBpdm90KSkge1xuICAvLyAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwaXZvdCBmaWVsZCBcIiR7cGl2b3R9XCIsIG5vdCBhIG5lc3RlZCBmaWVsZGApO1xuICAvLyB9XG4gIGlmIChbT1JfT1AsIEFORF9PUCwgTk9UX09QXS5pbmNsdWRlcyhvcCkpIHtcbiAgICByZXR1cm4gZ2V0R3JvdXBGaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KTtcbiAgfSBlbHNlIGlmIChbSU5fT1AsIE5PVF9JTl9PUCwgU09NRV9OT1RfSU5fT1BdLmluY2x1ZGVzKG9wKSkge1xuICAgIGlmIChgJHt2YWx1ZVswXX1gLmluY2x1ZGVzKFJFR0VYKSkge1xuICAgICAgcmV0dXJuIGdldFJlZ2V4RmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSk7XG4gICAgfSBlbHNlIGlmIChgJHt2YWx1ZVswXX1gLmluY2x1ZGVzKFNFVF9JRCkpIHtcbiAgICAgIHJldHVybiBnZXRTZXRGaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KTtcbiAgICB9IGVsc2UgaWYgKGAke3ZhbHVlWzBdfWAuaW5jbHVkZXMoTUlTU0lORykpIHtcbiAgICAgIHJldHVybiBnZXRNaXNzaW5nRmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBnZXRUZXJtRmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKFtBTExfT1BdLmluY2x1ZGVzKG9wKSkge1xuICAgIHJldHVybiBnZXRHcm91cEZpbHRlcih7XG4gICAgICBuZXN0ZWRGaWVsZHMsXG4gICAgICBmaWx0ZXI6IHtcbiAgICAgICAgb3A6IEFORF9PUCxcbiAgICAgICAgcGl2b3Q6IHBpdm90IHx8ICcuJyxcbiAgICAgICAgY29udGVudDogZmlsdGVyLmNvbnRlbnQudmFsdWUubWFwKHYgPT4gKHtcbiAgICAgICAgICBvcDogSU5fT1AsXG4gICAgICAgICAgY29udGVudDoge1xuICAgICAgICAgICAgZmllbGQ6IGZpbHRlci5jb250ZW50LmZpZWxkLFxuICAgICAgICAgICAgdmFsdWU6IFt2XSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH0pO1xuICB9IGVsc2UgaWYgKFtHVF9PUCwgR1RFX09QLCBMVF9PUCwgTFRFX09QXS5pbmNsdWRlcyhvcCkpIHtcbiAgICByZXR1cm4gZ2V0UmFuZ2VGaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KTtcbiAgfSBlbHNlIGlmIChbQkVUV0VFTl9PUF0uaW5jbHVkZXMob3ApKSB7XG4gICAgcmV0dXJuIGdldEJldHdlZW5GaWx0ZXIoeyBuZXN0ZWRGaWVsZHMsIGZpbHRlciB9KTtcbiAgfSBlbHNlIGlmIChGSUxURVJfT1AgPT09IG9wKSB7XG4gICAgcmV0dXJuIGdldEZ1enp5RmlsdGVyKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXIgfSk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd1bmtub3duIG9wJyk7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHsgbmVzdGVkRmllbGRzLCBmaWx0ZXJzOiByYXdGaWx0ZXJzIH0pIHtcbiAgaWYgKE9iamVjdC5rZXlzKHJhd0ZpbHRlcnMgfHwge30pLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHt9O1xuICByZXR1cm4gb3BTd2l0Y2goe1xuICAgIG5lc3RlZEZpZWxkcyxcbiAgICBmaWx0ZXI6IG5vcm1hbGl6ZUZpbHRlcnMocmF3RmlsdGVycyksXG4gIH0pO1xufVxuIl19